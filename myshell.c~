#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include <unistd.h>
#include "command.h"
#define BUFSIZE 512
#define MAXARGS 8

int split_commandline(char *line, char *args[]);

/* メインプログラム */
int main(void){
  char buffer[BUFSIZE]; // コマンドラインからの入力受け付け用バッファ
  char *args[MAXARGS]; // 引数保存用
  int nargs; // 引数の数

  /* 入力の繰り返し */
  while(1){
    printf("> ");
    /* コマンドラインからの入力 */
    if(fgets(buffer, sizeof(buffer), stdin) == NULL) break;
    /* 入力の分割 */
    nargs = split_commandline(buffer, args);

    /* コマンド処理 */
    if(strcmp(args[0], "ls") == 0) ls(nargs, args);
    else if(strcmp(args[0], "cd") == 0) cd(args);
    else if(strcmp(args[0], "mv") == 0) mv(args);
    else if(strcmp(args[0], "cp") == 0) cp(args);
    else if(strcmp(args[0], "rm") == 0) rm(nargs, args);
    else if(strcmp(args[0], "ln") == 0) ln(args);
    else if(strcmp(args[0], "echo") == 0) echo(nargs,args);
    else if(strcmp(args[0], "pwd") == 0) pwd();
    else if(strcmp(args[0], "exit") == 0) break;
    else unknown(args);
  }
  return 0;
}

/* コマンドラインからの入力を分割する */
int split_commandline(char *line, char *args[]){
  char *p; // コマンドラインからの入力文字列
  int argc;  // 引数の数
  
  /* 空白文字を飛ばす */
  for(p = line; *p != '\0' && isspace(*p); p++);
  /* コマンドの保存 */
  args[0] = p;
  /* 引数の分割 */
  for(argc = 1; argc < MAXARGS; argc++) {
    /* 文字列の終わりまたは空白文字まで飛ばす */
    for(; *p != '\0' && !isspace(*p); p++);
    if(*p == '\0') break;
    /* 空白文字をナル文字に変換 */
    *p++ = '\0';
    /* 空白文字を飛ばす */
    for(; *p != '\0' && isspace(*p); p++);
    if(*p == '\0') break;
    /* 引数の保存 */
    args[argc] = p;
  }
  return argc;
}
